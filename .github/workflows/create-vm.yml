name: Try to Create OCI VM
# It will run every 5 minutes.
on:
  schedule:
    - cron: "*/5 * * * *"
  # Allows you to manually run this workflow from the Actions tab
  workflow_dispatch:

env:
  # 1. CRITICAL: Suppress the API Key Warning so logs are clean
  SUPPRESS_LABEL_WARNING: true

  # 2. Hardcoded Mumbai Values (Taken from your successful JS request)
  # You can keep these here safely since they aren't secret passwords.
  AD_NAME: "qaqb:AP-MUMBAI-1-AD-1"
  IMAGE_ID: "ocid1.image.oc1.ap-mumbai-1.aaaaaaaahzcec4tjbvlvkptojwrc5zo4zazgdnwwyg5f5ayjpkreigtzwpxa"
  SUBNET_ID: "ocid1.subnet.oc1.ap-mumbai-1.aaaaaaaal7czmysz7hqztjcrt72oaoipcqo6rin4w5bvq64vfrxbjtw7nx4q"
  OCI_CLI_REGION: "ap-mumbai-1"

  # 3. Secrets (Keep these in GitHub Secrets)
  COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
  OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
  OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
  OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
  OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Cache pip packages
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: ${{ runner.os }}-pip-oci-cli-v1

      - name: Add OCI CLI to path
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Setup OCI CLI and Try to Create VM
        id: create_vm
        # This forces the job to succeed so the cache will save.
        continue-on-error: true 
        run: |
          set -o pipefail

          pip install oci-cli

          # Create the OCI directory
          mkdir -p /home/runner/.oci

          # Write the Key File
          echo "${{ secrets.OCI_CLI_KEY_CONTENT }}" > /home/runner/.oci/oci_api_key.pem
          chmod 600 /home/runner/.oci/oci_api_key.pem

          # Write the Config File
          # IMPORTANT: Using absolute paths (/home/runner) is safer than (~) in CI environments
          echo "[DEFAULT]" > /home/runner/.oci/config
          echo "user=${{ secrets.OCI_CLI_USER }}" >> /home/runner/.oci/config
          echo "tenancy=${{ secrets.OCI_CLI_TENANCY }}" >> /home/runner/.oci/config
          echo "fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}" >> /home/runner/.oci/config
          echo "key_file=/home/runner/.oci/oci_api_key.pem" >> /home/runner/.oci/config
          echo "region=${{ env.OCI_CLI_REGION }}" >> /home/runner/.oci/config
          
          # Write SSH Key
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > /home/runner/my_ssh_key.pub

          # --- VERIFICATION LOG ---
          echo "Targeting Region: ${{ env.OCI_CLI_REGION }}"
          echo "Targeting AD: $AD_NAME"
          # ------------------------

          # Launch Command
          # Note: I set OCPUs to 4 and Memory to 24 (Max Always Free Limits)
          # If you prefer your JS values (3 OCPUs, 18GB), change them below.
          OCI_OUTPUT=$(oci compute instance launch \
            --compartment-id "$COMPARTMENT_ID" \
            --availability-domain "$AD_NAME" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus":4,"memoryInGBs":24}' \
            --subnet-id "$SUBNET_ID" \
            --image-id "$IMAGE_ID" \
            --ssh-authorized-keys-file "/home/runner/my_ssh_key.pub" \
            --assign-public-ip true \
            --display-name "coolify-vm" \
            --boot-volume-size-in-gbs 200 2>&1 || true)

          # Store the log
          echo "log_data<<EOF" >> $GITHUB_OUTPUT
          echo "$OCI_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Check for Success
          if echo "$OCI_OUTPUT" | grep -q '"lifecycle-state": "PROVISIONING"'; then
            echo "Success! 'PROVISIONING' state found in output."
            exit 0
          else
            echo "Error: Success string not found in OCI output. Failing the step."
            exit 1
          fi

      - name: Send Discord Notification
        if: always()
        uses: sarisia/actions-status-discord@v1.15.4
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "OCI VM Status: ${{ steps.create_vm.outcome }}"
          status: ${{ steps.create_vm.outcome }}
          color: ${{ steps.create_vm.outcome == 'success' && '0x28a745' || '0xdc3545' }}
          description: |
            Attempt to create A1.Flex VM in **MUMBAI**.
            **Status:** `${{ steps.create_vm.outcome }}`

            **Log Output:**
            ```json
            ${{ steps.create_vm.outputs.log_data }}
            ```
