name: Debug OCI Configuration

on:
  workflow_dispatch: # Run this manually

env:
  # Suppress the Python script warning
  SUPPRESS_LABEL_WARNING: true
  
  # Your Secrets
  COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
  IMAGE_ID: "ocid1.image.oc1.ap-singapore-1.aaaaaaaa5a3xwkk5vaichk47fms2uzvsqeriats2uorf6kwgq3l3nwrbhipa"
  SUBNET_ID: ${{ secrets.OCI_SUBNET_ID }}
  AD_NAME: "KClJ:AP-SINGAPORE-1-AD-1"
  OCI_CLI_REGION: "ap-singapore-1"

jobs:
  debug-oci-config:
    runs-on: ubuntu-latest
    steps:
      - name: Setup OCI CLI
        run: |
          pip install oci-cli
          mkdir -p /home/runner/.oci

      - name: Generate Config and Key Files
        run: |
          # write the private key
          echo "${{ secrets.OCI_CLI_KEY_CONTENT }}" > /home/runner/.oci/oci_api_key.pem
          chmod 600 /home/runner/.oci/oci_api_key.pem

          # Write the config file using absolute paths
          echo "[DEFAULT]" > /home/runner/.oci/config
          echo "user=${{ secrets.OCI_CLI_USER }}" >> /home/runner/.oci/config
          echo "tenancy=${{ secrets.OCI_CLI_TENANCY }}" >> /home/runner/.oci/config
          echo "fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}" >> /home/runner/.oci/config
          echo "key_file=/home/runner/.oci/oci_api_key.pem" >> /home/runner/.oci/config
          echo "region=${{ env.OCI_CLI_REGION }}" >> /home/runner/.oci/config

      - name: ðŸ” DIAGNOSTIC 1 - Check Config Formatting
        run: |
          echo "---------------------------------------------------"
          echo "checking config file for hidden spaces or format errors..."
          echo "(Sensitive values are masked with ***)"
          echo "---------------------------------------------------"
          # This prints the config but replaces the actual keys with *** so it is safe to view in logs
          cat /home/runner/.oci/config | sed 's/user=.*/user=***MASKED_USER_OCID***/' | sed 's/tenancy=.*/tenancy=***MASKED_TENANCY_OCID***/' | sed 's/fingerprint=.*/fingerprint=***MASKED_FINGERPRINT***/'
          echo "---------------------------------------------------"

      - name: ðŸ” DIAGNOSTIC 2 - Check Key File Structure
        run: |
          echo "Checking if Private Key file has correct header/footer..."
          # Print the first line and last line ONLY. 
          echo "First Line (Should be -----BEGIN...):"
          head -n 1 /home/runner/.oci/oci_api_key.pem
          echo "Last Line (Should be -----END...):"
          tail -n 1 /home/runner/.oci/oci_api_key.pem
          
          echo "Checking line count (Should be > 20):"
          wc -l /home/runner/.oci/oci_api_key.pem

      - name: ðŸ” DIAGNOSTIC 3 - Simple Connectivity Test
        id: conn_test
        run: |
          echo "Attempting to fetch Object Storage Namespace..."
          echo "If this fails, your AUTHENTICATION is wrong."
          echo "If this succeeds, your KEYS are correct."
          
          # We use --debug to see exactly what OCI is sending
          oci os ns get --debug

      - name: ðŸš€ Launch VM (Only runs if Auth succeeds)
        if: steps.conn_test.outcome == 'success'
        run: |
          echo "Auth worked! Now trying to launch VM..."
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > /home/runner/my_ssh_key.pub
          
          oci compute instance launch \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --availability-domain "$AD_NAME" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus":4,"memoryInGBs":24}' \
            --subnet-id "$SUBNET_ID" \
            --image-id "$IMAGE_ID" \
            --ssh-authorized-keys-file "/home/runner/my_ssh_key.pub" \
            --assign-public-ip true \
            --display-name "coolify-vm" \
            --boot-volume-size-in-gbs 200
